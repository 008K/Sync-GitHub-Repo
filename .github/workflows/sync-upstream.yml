name: Sync Upstream Repositories

# è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹ README.md

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹åŒæ­¥ (UTC 0:00)
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Parse sync configuration
        id: set-matrix
        env:
          SYNC_REPOS: ${{ vars.SYNC_REPOS }}
        run: |
          if [ -z "$SYNC_REPOS" ]; then
            echo "âŒ é”™è¯¯ï¼šè¯·åœ¨ä»“åº“ Settings â†’ Secrets and variables â†’ Actions â†’ Variables ä¸­é…ç½® SYNC_REPOS"
            echo "æ ¼å¼ç¤ºä¾‹ï¼š"
            echo '[{"upstream": "https://github.com/owner/repo.git", "target": "myuser/repo", "branch": "main", "token": "TOKEN_NAME"}]'
            exit 1
          fi
          
          if ! echo "$SYNC_REPOS" | jq empty 2>/dev/null; then
            echo "âŒ é”™è¯¯ï¼šSYNC_REPOS çš„ JSON æ ¼å¼ä¸æ­£ç¡®"
            echo "è¯·æ£€æŸ¥ JSON è¯­æ³•ï¼ˆå¼•å·ã€é€—å·ã€æ‹¬å·æ˜¯å¦æ­£ç¡®ï¼‰"
            exit 1
          fi
          
          if [ "$(echo "$SYNC_REPOS" | jq 'type')" != '"array"' ]; then
            echo "âŒ é”™è¯¯ï¼šSYNC_REPOS å¿…é¡»æ˜¯ JSON æ•°ç»„æ ¼å¼"
            exit 1
          fi
          
          REPO_COUNT=$(echo "$SYNC_REPOS" | jq length)
          if [ "$REPO_COUNT" -eq 0 ]; then
            echo "âŒ é”™è¯¯ï¼šSYNC_REPOS æ•°ç»„ä¸ºç©ºï¼Œæ²¡æœ‰é…ç½®ä»»ä½•åŒæ­¥ä»»åŠ¡"
            exit 1
          fi
          
          MATRIX_JSON=$(echo "$SYNC_REPOS" | jq -c .)
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ å·²åŠ è½½ $REPO_COUNT ä¸ªåŒæ­¥ä»»åŠ¡"
  sync:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.prepare.outputs.matrix) }}
    
    steps:
      - name: Sync ${{ matrix.repo.target }}
        id: sync
        env:
          UPSTREAM_REPO: ${{ matrix.repo.upstream }}
          TARGET_REPO: ${{ matrix.repo.target }}
          SYNC_BRANCH: ${{ matrix.repo.branch }}
          SYNC_MIRROR: ${{ matrix.repo.mode }}
          REPO_TOKEN: ${{ secrets[matrix.repo.token] }}
        run: |
          echo "========================================" 
          echo "ğŸ“‹ åŒæ­¥é…ç½®ï¼š"
          echo "   ä¸Šæ¸¸ä»“åº“: $UPSTREAM_REPO"
          echo "   ç›®æ ‡ä»“åº“: $TARGET_REPO"
          echo "   åŒæ­¥åˆ†æ”¯: $SYNC_BRANCH"
          echo "   é•œåƒæ¨¡å¼: ${SYNC_MIRROR:-'æœªè®¾ç½®'}"
          echo "========================================"
          
          SYNC_STATUS="unknown"
          
          TARGET_URL="https://x-access-token:${REPO_TOKEN}@github.com/${TARGET_REPO}.git"
          
          if [ -z "$REPO_TOKEN" ]; then
            echo "âŒ [$TARGET_REPO] é”™è¯¯ï¼šToken æœªé…ç½®æˆ–åç§°é”™è¯¯"
            echo "   è¯·æ£€æŸ¥ Secrets ä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ Token"
            SYNC_STATUS="error"
            echo "status=$SYNC_STATUS" >> $GITHUB_OUTPUT
            echo "repo=$TARGET_REPO" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          UPSTREAM_SHA=$(git ls-remote "$UPSTREAM_REPO" "refs/heads/$SYNC_BRANCH" | cut -f1)
          
          if [ -z "$UPSTREAM_SHA" ]; then
            echo "âŒ [$TARGET_REPO] é”™è¯¯ï¼šä¸Šæ¸¸ä»“åº“çš„ $SYNC_BRANCH åˆ†æ”¯ä¸å­˜åœ¨"
            echo "   è¯·æ£€æŸ¥ä¸Šæ¸¸ä»“åº“åœ°å€å’Œåˆ†æ”¯åç§°æ˜¯å¦æ­£ç¡®"
            SYNC_STATUS="error"
            echo "status=$SYNC_STATUS" >> $GITHUB_OUTPUT
            echo "repo=$TARGET_REPO" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "ä¸Šæ¸¸ $SYNC_BRANCH åˆ†æ”¯æœ€æ–° commit: $UPSTREAM_SHA"
          
          TARGET_SHA=$(git ls-remote "$TARGET_URL" "refs/heads/$SYNC_BRANCH" 2>/dev/null | cut -f1 || echo "")
          echo "ç›®æ ‡ä»“åº“ $SYNC_BRANCH åˆ†æ”¯å½“å‰ commit: ${TARGET_SHA:-'(åˆ†æ”¯ä¸å­˜åœ¨)'}"
          
          if [ "$UPSTREAM_SHA" = "$TARGET_SHA" ]; then
            echo "âœ… [$TARGET_REPO] å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥"
            SYNC_STATUS="skipped"
          else
            echo "ğŸ”„ [$TARGET_REPO] æ£€æµ‹åˆ°æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
            
            git clone --bare "$UPSTREAM_REPO" upstream-repo
            cd upstream-repo
            
            # åˆ¤æ–·æ˜¯å¦ä½¿ç”¨é¡åƒæ¨¡å¼
            if [ -z "$SYNC_MIRROR" ]; then
                # ç©ºå€¼ - æ™®é€šæ¨¡å¼ï¼ˆæœ€å¸¸ç”¨ï¼‰
                echo "ğŸ” ä½¿ç”¨æ™®é€šæ¨¡å¼åŒæ­¥"
                if git push --force "$TARGET_URL" "$SYNC_BRANCH:$SYNC_BRANCH"; then
                    echo "âœ… [$TARGET_REPO] åŒæ­¥å®Œæˆï¼"
                    SYNC_STATUS="synced"
                else
                    echo "âŒ [$TARGET_REPO] åŒæ­¥å¤±è´¥ï¼"
                    SYNC_STATUS="failed"
                fi
            elif [ "$SYNC_MIRROR" = "mirror" ]; then
                # é•œåƒæ¨¡å¼
                echo "ğŸ” ä½¿ç”¨é•œåƒæ¨¡å¼åŒæ­¥ (--mirror)"
                if git push --mirror --force "$TARGET_URL"; then
                    echo "âœ… [$TARGET_REPO] é•œåƒåŒæ­¥å®Œæˆï¼"
                    SYNC_STATUS="synced"
                else
                    echo "âŒ [$TARGET_REPO] é•œåƒåŒæ­¥å¤±è´¥ï¼"
                    SYNC_STATUS="failed"
                fi
            elif [ "$SYNC_MIRROR" = "tags" ]; then
                # æ ‡ç­¾æ¨¡å¼
                echo "ğŸ” ä½¿ç”¨æ ‡ç­¾æ¨¡å¼åŒæ­¥ (--tags)"
                if git push --force --tags "$TARGET_URL"; then
                    echo "âœ… [$TARGET_REPO] æ ‡ç­¾åŒæ­¥å®Œæˆï¼"
                    SYNC_STATUS="synced"
                else
                    echo "âŒ [$TARGET_REPO] æ ‡ç­¾åŒæ­¥å¤±è´¥ï¼"
                    SYNC_STATUS="failed"
                fi
            else
                # è™•ç†æ„å¤–å€¼ï¼ˆå¯é¸çš„éŒ¯èª¤è™•ç†ï¼‰
                echo "âš ï¸  æœªçŸ¥çš„ SYNC_MIRROR å€¼: '$SYNC_MIRROR'ï¼Œä½¿ç”¨æ™®é€šæ¨¡å¼"
                if git push --force "$TARGET_URL" "$SYNC_BRANCH:$SYNC_BRANCH"; then
                    echo "âœ… [$TARGET_REPO] åŒæ­¥å®Œæˆï¼"
                    SYNC_STATUS="synced"
                else
                    echo "âŒ [$TARGET_REPO] åŒæ­¥å¤±è´¥ï¼"
                    SYNC_STATUS="failed"
                fi
            fi
          fi
          
          echo "status=$SYNC_STATUS" >> $GITHUB_OUTPUT
          echo "repo=$TARGET_REPO" >> $GITHUB_OUTPUT
      
      - name: Save sync result
        if: always()
        run: |
          mkdir -p sync-results
          echo "${{ matrix.repo.target }}|${{ steps.sync.outputs.status || 'failed' }}" > sync-results/result-${{ strategy.job-index }}.txt
      
      - name: Upload sync result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-result-${{ strategy.job-index }}
          path: sync-results/
          retention-days: 1

  collect:
    needs: sync
    runs-on: ubuntu-latest
    if: always()
    outputs:
      summary: ${{ steps.collect.outputs.summary }}
      synced_count: ${{ steps.collect.outputs.synced_count }}
      skipped_count: ${{ steps.collect.outputs.skipped_count }}
      failed_count: ${{ steps.collect.outputs.failed_count }}
    steps:
      - name: Download all sync results
        uses: actions/download-artifact@v4
        with:
          pattern: sync-result-*
          merge-multiple: true
          path: sync-results/
      
      - name: Collect results
        id: collect
        run: |
          SYNCED=""
          SKIPPED=""
          FAILED=""
          SYNCED_COUNT=0
          SKIPPED_COUNT=0
          FAILED_COUNT=0
          
          if [ -d "sync-results" ]; then
            for file in sync-results/*.txt; do
              if [ -f "$file" ]; then
                while IFS='|' read -r repo status; do
                  case "$status" in
                    synced)  
                      SYNCED="$SYNCED\nâœ… $repo"
                      SYNCED_COUNT=$((SYNCED_COUNT + 1))
                      ;;
                    skipped) 
                      SKIPPED="$SKIPPED\nâ­ï¸ $repo (å·²æ˜¯æœ€æ–°)"
                      SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
                      ;;
                    *)       
                      FAILED="$FAILED\nâŒ $repo"
                      FAILED_COUNT=$((FAILED_COUNT + 1))
                      ;;
                  esac
                done < "$file"
              fi
            done
          fi
          
          SUMMARY=""
          if [ -n "$SYNCED" ]; then
            SUMMARY="${SUMMARY}ã€å·²åŒæ­¥ã€‘${SYNCED}\n\n"
          fi
          if [ -n "$SKIPPED" ]; then
            SUMMARY="${SUMMARY}ã€å·²è·³è¿‡ã€‘${SKIPPED}\n\n"
          fi
          if [ -n "$FAILED" ]; then
            SUMMARY="${SUMMARY}ã€å¤±è´¥ã€‘${FAILED}\n\n"
          fi
          
          if [ -z "$SUMMARY" ]; then
            SUMMARY="æ²¡æœ‰åŒæ­¥ä»»åŠ¡æ‰§è¡Œ"
          fi
          
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "synced_count=$SYNCED_COUNT" >> $GITHUB_OUTPUT
          echo "skipped_count=$SKIPPED_COUNT" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
  notify:
    needs: [sync, collect]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Send notifications
        env:
          NOTIFY_CONFIG: ${{ vars.NOTIFY_CONFIG }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}
          SERVERCHAN_KEY: ${{ secrets.SERVERCHAN_KEY }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SYNC_SUMMARY: ${{ needs.collect.outputs.summary }}
          SYNCED_COUNT: ${{ needs.collect.outputs.synced_count }}
          SKIPPED_COUNT: ${{ needs.collect.outputs.skipped_count }}
          FAILED_COUNT: ${{ needs.collect.outputs.failed_count }}
          REPO_NAME: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -z "$NOTIFY_CONFIG" ]; then
            echo "â„¹ï¸ æœªé…ç½® NOTIFY_CONFIGï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          if ! echo "$NOTIFY_CONFIG" | jq empty 2>/dev/null; then
            echo "âš ï¸ NOTIFY_CONFIG JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œè·³è¿‡é€šçŸ¥"
            echo "è¯·æ£€æŸ¥ JSON è¯­æ³•æ˜¯å¦æ­£ç¡®"
            exit 0
          fi
          
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          SYNCED_COUNT=${SYNCED_COUNT:-0}
          SKIPPED_COUNT=${SKIPPED_COUNT:-0}
          FAILED_COUNT=${FAILED_COUNT:-0}
          
          if [ "$FAILED_COUNT" -gt 0 ]; then
            STATUS="âŒ æœ‰ ${FAILED_COUNT} ä¸ªå¤±è´¥"
            TITLE="GitHub ä»“åº“åŒæ­¥å¤±è´¥"
          elif [ "$SYNCED_COUNT" -gt 0 ]; then
            STATUS="âœ… åŒæ­¥äº† ${SYNCED_COUNT} ä¸ªä»“åº“"
            TITLE="GitHub ä»“åº“åŒæ­¥æˆåŠŸ"
          elif [ "$SKIPPED_COUNT" -gt 0 ]; then
            STATUS="â­ï¸ ${SKIPPED_COUNT} ä¸ªä»“åº“å·²æ˜¯æœ€æ–°"
            TITLE="GitHub ä»“åº“æ— éœ€åŒæ­¥"
          else
            STATUS="â„¹ï¸ æ— ä»»åŠ¡æ‰§è¡Œ"
            TITLE="GitHub ä»“åº“åŒæ­¥æ£€æŸ¥å®Œæˆ"
          fi
          
          MESSAGE=$(printf "%s\n\næ—¶é—´: %s\nçŠ¶æ€: %s\nä»“åº“: %s\nè¿è¡Œ: %s\n\n%s" \
            "$TITLE" "$TIMESTAMP" "$STATUS" "$REPO_NAME" "$RUN_URL" "$SYNC_SUMMARY")
          
          # JSON è½¬ä¹‰çš„æ¶ˆæ¯ï¼ˆç”¨äº Discordã€é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ï¼‰
          MESSAGE_ESCAPED=$(echo "$MESSAGE" | jq -Rs .)
          
          # ========== Telegram ==========
          if echo "$NOTIFY_CONFIG" | jq -e '.telegram' > /dev/null 2>&1; then
            CHAT_ID=$(echo "$NOTIFY_CONFIG" | jq -r '.telegram.chat_id')
            if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$CHAT_ID" ] && [ "$CHAT_ID" != "null" ]; then
              echo "ğŸ“¤ å‘é€ Telegram é€šçŸ¥..."
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                -d "chat_id=${CHAT_ID}" \
                --data-urlencode "text=${MESSAGE}" || echo "âš ï¸ Telegram å‘é€å¤±è´¥"
            fi
          fi
          
          # ========== Discord ==========
          if echo "$NOTIFY_CONFIG" | jq -e '.discord' > /dev/null 2>&1; then
            if [ -n "$DISCORD_WEBHOOK" ]; then
              echo "ğŸ“¤ å‘é€ Discord é€šçŸ¥..."
              curl -s -X POST "$DISCORD_WEBHOOK" \
                -H "Content-Type: application/json" \
                -d "{\"content\": ${MESSAGE_ESCAPED}}" || echo "âš ï¸ Discord å‘é€å¤±è´¥"
            fi
          fi
          
          # ========== é’‰é’‰ DingTalk ==========
          if echo "$NOTIFY_CONFIG" | jq -e '.dingtalk' > /dev/null 2>&1; then
            if [ -n "$DINGTALK_WEBHOOK" ]; then
              echo "ğŸ“¤ å‘é€é’‰é’‰é€šçŸ¥..."
              curl -s -X POST "$DINGTALK_WEBHOOK" \
                -H "Content-Type: application/json" \
                -d "{\"msgtype\": \"text\", \"text\": {\"content\": ${MESSAGE_ESCAPED}}}" || echo "âš ï¸ é’‰é’‰å‘é€å¤±è´¥"
            fi
          fi
          
          # ========== ä¼ä¸šå¾®ä¿¡ WeCom ==========
          if echo "$NOTIFY_CONFIG" | jq -e '.wecom' > /dev/null 2>&1; then
            if [ -n "$WECOM_WEBHOOK" ]; then
              echo "ğŸ“¤ å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥..."
              curl -s -X POST "$WECOM_WEBHOOK" \
                -H "Content-Type: application/json" \
                -d "{\"msgtype\": \"text\", \"text\": {\"content\": ${MESSAGE_ESCAPED}}}" || echo "âš ï¸ ä¼ä¸šå¾®ä¿¡å‘é€å¤±è´¥"
            fi
          fi
          
          # ========== Serveré…± ServerChan ==========
          if echo "$NOTIFY_CONFIG" | jq -e '.serverchan' > /dev/null 2>&1; then
            if [ -n "$SERVERCHAN_KEY" ]; then
              echo "ğŸ“¤ å‘é€ Serveré…± é€šçŸ¥..."
              curl -s -X POST "https://sctapi.ftqq.com/${SERVERCHAN_KEY}.send" \
                --data-urlencode "title=${TITLE}" \
                --data-urlencode "desp=${MESSAGE}" || echo "âš ï¸ Serveré…±å‘é€å¤±è´¥"
            fi
          fi
          
          # ========== é‚®ä»¶ Email ==========
          if echo "$NOTIFY_CONFIG" | jq -e '.email' > /dev/null 2>&1; then
            EMAIL_TO=$(echo "$NOTIFY_CONFIG" | jq -r '.email.to')
            EMAIL_FROM=$(echo "$NOTIFY_CONFIG" | jq -r '.email.from // "noreply@github.com"')
            if [ -n "$SMTP_SERVER" ] && [ -n "$SMTP_USERNAME" ] && [ -n "$SMTP_PASSWORD" ] && [ -n "$EMAIL_TO" ] && [ "$EMAIL_TO" != "null" ]; then
              echo "ğŸ“¤ å‘é€é‚®ä»¶é€šçŸ¥..."
              # è§£ææœåŠ¡å™¨å’Œç«¯å£
              SMTP_HOST=$(echo "$SMTP_SERVER" | cut -d: -f1)
              SMTP_PORT=$(echo "$SMTP_SERVER" | cut -d: -f2)
              
              # æ„å»ºé‚®ä»¶å†…å®¹
              EMAIL_CONTENT=$(printf "From: %s\nTo: %s\nSubject: %s\nContent-Type: text/plain; charset=utf-8\n\n%s" \
                "$EMAIL_FROM" "$EMAIL_TO" "$TITLE" "$MESSAGE")
              
              # ä½¿ç”¨ curl å‘é€é‚®ä»¶
              echo "$EMAIL_CONTENT" | curl -s --ssl-reqd \
                --url "smtps://${SMTP_HOST}:${SMTP_PORT}" \
                --user "${SMTP_USERNAME}:${SMTP_PASSWORD}" \
                --mail-from "${EMAIL_FROM}" \
                --mail-rcpt "${EMAIL_TO}" \
                -T - || echo "âš ï¸ é‚®ä»¶å‘é€å¤±è´¥"
            fi
          fi
          
          echo "âœ… é€šçŸ¥å‘é€å®Œæˆ"
